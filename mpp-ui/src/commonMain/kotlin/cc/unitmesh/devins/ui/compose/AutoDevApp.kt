package cc.unitmesh.devins.ui.compose

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.text.selection.SelectionContainer
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import cc.unitmesh.agent.Platform
import cc.unitmesh.devins.db.ModelConfigRepository
import cc.unitmesh.devins.ui.compose.editor.DevInEditorInput
import cc.unitmesh.devins.workspace.WorkspaceManager
import cc.unitmesh.devins.ui.compose.chat.*
import cc.unitmesh.llm.KoogLLMService
import cc.unitmesh.llm.ModelConfig
import cc.unitmesh.devins.llm.ChatHistoryManager
import cc.unitmesh.devins.llm.Message
import kotlinx.coroutines.launch
import cc.unitmesh.devins.ui.platform.createFileChooser
import cc.unitmesh.devins.filesystem.DefaultFileSystem

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AutoDevApp() {
    val scope = rememberCoroutineScope()
    var compilerOutput by remember { mutableStateOf("") }

    var messages by remember { mutableStateOf<List<Message>>(emptyList()) }
    var currentStreamingOutput by remember { mutableStateOf("") }
    var isLLMProcessing by remember { mutableStateOf(false) }
    
    val chatHistoryManager = remember { ChatHistoryManager.getInstance() }
    
    LaunchedEffect(Unit) {
        messages = chatHistoryManager.getMessages()
    }
    
    var currentModelConfig by remember { mutableStateOf<ModelConfig?>(null) }
    var allModelConfigs by remember { mutableStateOf<List<ModelConfig>>(emptyList()) }
    var llmService by remember { mutableStateOf<KoogLLMService?>(null) }
    var showConfigWarning by remember { mutableStateOf(false) }
    var showDebugDialog by remember { mutableStateOf(false) }
    var showErrorDialog by remember { mutableStateOf(false) }
    var errorMessage by remember { mutableStateOf("") }
    var showModelConfigDialog by remember { mutableStateOf(false) }
    var selectedAgent by remember { mutableStateOf("Default") }
    
    val availableAgents = listOf("Default", "clarify", "code-review", "test-gen", "refactor")
    
    var currentWorkspace by remember { mutableStateOf(WorkspaceManager.getCurrentOrEmpty()) }

    val workspaceState by WorkspaceManager.workspaceFlow.collectAsState()

    LaunchedEffect(workspaceState) {
        workspaceState?.let { workspace ->
            currentWorkspace = workspace
        }
    }

    LaunchedEffect(Unit) {
        if (!WorkspaceManager.hasActiveWorkspace()) {
            val defaultPath = "/Users/phodal/IdeaProjects/untitled"
            val fileSystem = DefaultFileSystem(defaultPath)
            if (fileSystem.exists(defaultPath)) {
                WorkspaceManager.openWorkspace("Default Project", defaultPath)
            } else {
                WorkspaceManager.openEmptyWorkspace("Empty Workspace")
            }
        }
    }
    
    val repository = remember {
        ModelConfigRepository.getInstance()
    }
    
    LaunchedEffect(Unit) {
        try {
            val savedConfigs = repository.getAllConfigs()

            // ‰øùÂ≠òÊâÄÊúâÈÖçÁΩÆÂà∞Áä∂ÊÄÅ
            allModelConfigs = savedConfigs

            if (savedConfigs.isNotEmpty()) {
                val defaultConfig = repository.getDefaultConfig()
                val configToUse = defaultConfig ?: savedConfigs.first()

                currentModelConfig = configToUse
                if (configToUse.isValid()) {
                    llmService = KoogLLMService.create(configToUse)
                }
            }
        } catch (e: Exception) {
            println("‚ö†Ô∏è Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•: ${e.message}")
        }
    }
    
    val callbacks = createChatCallbacks(
        fileSystem = currentWorkspace.fileSystem,
        llmService = llmService,
        chatHistoryManager = chatHistoryManager,
        scope = scope,
        onCompilerOutput = { compilerOutput = it },
        onUserMessage = { userMsg ->
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞Êú¨Âú∞Áä∂ÊÄÅ
            messages = messages + userMsg
        },
        onStreamingOutput = { output ->
            // Êõ¥Êñ∞ÊµÅÂºèËæìÂá∫
            currentStreamingOutput = output
        },
        onAssistantMessage = { assistantMsg ->
            // AI ÂìçÂ∫îÂÆåÊàêÔºåÊ∑ªÂä†Âà∞Êú¨Âú∞Áä∂ÊÄÅ
            messages = messages + assistantMsg
            currentStreamingOutput = ""  // Ê∏ÖÁ©∫ÊµÅÂºèËæìÂá∫
        },
        onProcessingChange = { isLLMProcessing = it },
        onError = { 
            errorMessage = it
            showErrorDialog = true
        },
        onConfigWarning = { showConfigWarning = true }
    )
    
    // ÊâìÂºÄÁõÆÂΩïÈÄâÊã©Âô®
    fun openDirectoryChooser() {
        scope.launch {
            val fileChooser = createFileChooser()
            val selectedPath = fileChooser.chooseDirectory(
                title = "Select Project Directory",
                initialDirectory = currentWorkspace.rootPath
            )

            selectedPath?.let { path ->
                val projectName = path.substringAfterLast('/')
                try {
                    WorkspaceManager.openWorkspace(projectName, path)
                    println("üìÅ Â∑≤ÂàáÊç¢È°πÁõÆË∑ØÂæÑ: $path")
                } catch (e: Exception) {
                    errorMessage = "ÂàáÊç¢Â∑•‰ΩúÁ©∫Èó¥Â§±Ë¥•: ${e.message}"
                    showErrorDialog = true
                }
            }
        }
    }
    
    Scaffold(
        modifier = Modifier.fillMaxSize(),
        containerColor = MaterialTheme.colorScheme.background,
        // ËÆ© Scaffold Ëá™Âä®Â§ÑÁêÜÁ≥ªÁªüÊ†èÂíåÈîÆÁõòÔºå‰ΩÜÊàë‰ª¨‰ºöÂú®ÁªÑ‰ª∂Á∫ßÂà´ÂæÆË∞É
        contentWindowInsets = WindowInsets.systemBars.only(WindowInsetsSides.Horizontal)
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // È°∂ÈÉ®Â∑•ÂÖ∑Ê†è - Ê∑ªÂä†Áä∂ÊÄÅÊ†èËæπË∑ù
            TopBarMenu(
                hasHistory = messages.isNotEmpty(),
                hasDebugInfo = compilerOutput.isNotEmpty(),
                currentModelConfig = currentModelConfig,
                availableConfigs = allModelConfigs,
                selectedAgent = selectedAgent,
                availableAgents = availableAgents,
                onOpenDirectory = { openDirectoryChooser() },
                onClearHistory = { 
                    chatHistoryManager.clearCurrentSession()
                    messages = emptyList()
                    currentStreamingOutput = ""
                    println("üóëÔ∏è [SimpleAIChat] ËÅäÂ§©ÂéÜÂè≤Â∑≤Ê∏ÖÁ©∫")
                },
                onShowDebug = { showDebugDialog = true },
                onModelConfigChange = { config ->
                    currentModelConfig = config
                    if (config.isValid()) {
                        try {
                            llmService = KoogLLMService.create(config)
                            println("‚úÖ ÂàáÊç¢Ê®°Âûã: ${config.provider.displayName} / ${config.modelName}")
                        } catch (e: Exception) {
                            println("‚ùå ÂàáÊç¢Ê®°ÂûãÂ§±Ë¥•: ${e.message}")
                        }
                    }
                },
                onAgentChange = { agent ->
                    selectedAgent = agent
                    println("ü§ñ ÂàáÊç¢ Agent: $agent")
                },
                onShowModelConfig = { showModelConfigDialog = true },
                modifier = Modifier
                    .statusBarsPadding() // Ê∑ªÂä†Áä∂ÊÄÅÊ†èËæπË∑ù
            )
            
            // Âà§Êñ≠ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫Á¥ßÂáëÂ∏ÉÂ±ÄÔºàÊúâÊ∂àÊÅØÂéÜÂè≤ÊàñÊ≠£Âú®Â§ÑÁêÜÔºâ
            val isCompactMode = messages.isNotEmpty() || isLLMProcessing
            
            if (isCompactMode) {
                // Á¥ßÂáëÊ®°ÂºèÔºöÊòæÁ§∫Ê∂àÊÅØÂàóË°®ÔºåËæìÂÖ•Ê°ÜÂú®Â∫ïÈÉ®
                MessageList(
                    messages = messages,
                    isLLMProcessing = isLLMProcessing,
                    currentOutput = currentStreamingOutput,
                    projectPath = currentWorkspace.rootPath,
                    fileSystem = currentWorkspace.fileSystem,
                    modifier = Modifier
                        .fillMaxWidth()
                        .weight(1f)
                )
                
                // Â∫ïÈÉ®ËæìÂÖ•Ê°Ü - Á¥ßÂáëÊ®°ÂºèÔºà‰∏ÄË°åÔºâ
                // ‰ΩøÁî® Column ÂåÖË£Ö‰ª•Ê≠£Á°ÆÂ§ÑÁêÜÈîÆÁõòÈÅÆÊå°
                Column(
                    modifier = Modifier
                        .fillMaxWidth()
                        .imePadding() // ÈîÆÁõòÂºπÂá∫Êó∂ÔºåÊï¥‰∏™Âå∫ÂüüÂêë‰∏äÊé®
                        .navigationBarsPadding() // Ê∑ªÂä†ÂØºËà™Ê†èËæπË∑ù
                ) {
                    Surface(
                        modifier = Modifier.fillMaxWidth(),
                        shadowElevation = 8.dp,
                        tonalElevation = 2.dp
                    ) {
                    DevInEditorInput(
                        initialText = "",
                        placeholder = "Type your message...",
                        callbacks = callbacks,
                        completionManager = currentWorkspace.completionManager,
                        isCompactMode = true,
                        initialModelConfig = currentModelConfig,
                        availableConfigs = allModelConfigs,
                        onModelConfigChange = { config ->
                            currentModelConfig = config
                            if (config.isValid()) {
                                try {
                                    llmService = KoogLLMService.create(config)
                                    println("‚úÖ ÂàáÊç¢Ê®°Âûã: ${config.provider.displayName} / ${config.modelName}")
                                } catch (e: Exception) {
                                    println("‚ùå ÂàáÊç¢Ê®°ÂûãÂ§±Ë¥•: ${e.message}")
                                }
                            }
                        },
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp)
                    )
                    }
                }
            } else {
                // ÈªòËÆ§Ê®°ÂºèÔºöËæìÂÖ•Ê°ÜÂ±Ö‰∏≠ÊòæÁ§∫
                // Android: ‰ΩøÁî®Êõ¥Á¥ßÂáëÁöÑÂ∏ÉÂ±ÄÂíåÊõ¥Â∞èÁöÑ padding
                val isAndroid = Platform.isAndroid

                // ‰ΩøÁî® Box ÊîØÊåÅÈîÆÁõòÈÅøËÆ©
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .imePadding() // ÈîÆÁõòÂºπÂá∫Êó∂Ëá™Âä®Ë∞ÉÊï¥
                        .padding(if (isAndroid) 16.dp else 32.dp),
                    contentAlignment = Alignment.Center
                ) {
                    // ÂÆåÊï¥ÁöÑËæìÂÖ•ÁªÑ‰ª∂ÔºàÂåÖÂê´Â∫ïÈÉ®Â∑•ÂÖ∑Ê†èÔºâ
                    DevInEditorInput(
                        initialText = "",
                        placeholder = "Type your message...",
                        callbacks = callbacks,
                        completionManager = currentWorkspace.completionManager,
                        initialModelConfig = currentModelConfig,
                        availableConfigs = allModelConfigs,
                        onModelConfigChange = { config ->
                            currentModelConfig = config
                            if (config.isValid()) {
                                try {
                                    llmService = KoogLLMService.create(config)
                                    scope.launch {
                                        try {
                                            repository.saveConfig(config, setAsDefault = true)
                                            allModelConfigs = repository.getAllConfigs()
                                            println("‚úÖ Ê®°ÂûãÈÖçÁΩÆÂ∑≤‰øùÂ≠ò")
                                        } catch (e: Exception) {
                                            println("‚ö†Ô∏è ‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•: ${e.message}")
                                        }
                                    }
                                } catch (e: Exception) {
                                    println("‚ùå ÈÖçÁΩÆ LLM ÊúçÂä°Â§±Ë¥•: ${e.message}")
                                    llmService = null
                                }
                            }
                        },
                        modifier = Modifier.fillMaxWidth(if (isAndroid) 1f else 0.9f)
                    )
                }
            }
        }
    }
    
        // Model Config Dialog
        if (showModelConfigDialog) {
            cc.unitmesh.devins.ui.compose.editor.ModelConfigDialog(
                currentConfig = currentModelConfig ?: ModelConfig(),
                onDismiss = { showModelConfigDialog = false },
                onSave = { newConfig ->
                    currentModelConfig = newConfig
                    if (newConfig.isValid()) {
                        try {
                            llmService = KoogLLMService.create(newConfig)
                            scope.launch {
                                try {
                                    repository.saveConfig(newConfig, setAsDefault = true)
                                    allModelConfigs = repository.getAllConfigs()
                                    println("‚úÖ Ê®°ÂûãÈÖçÁΩÆÂ∑≤‰øùÂ≠ò")
                                } catch (e: Exception) {
                                    println("‚ö†Ô∏è ‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•: ${e.message}")
                                }
                            }
                        } catch (e: Exception) {
                            println("‚ùå ÈÖçÁΩÆ LLM ÊúçÂä°Â§±Ë¥•: ${e.message}")
                            llmService = null
                        }
                    }
                    showModelConfigDialog = false
                }
            )
        }
        
        // Debug Dialog
        if (showDebugDialog) {
            DebugDialog(
                compilerOutput = compilerOutput,
                onDismiss = { showDebugDialog = false }
            )
        }
        
        // ÈÖçÁΩÆË≠¶ÂëäÂºπÁ™ó
        if (showConfigWarning) {
            AlertDialog(
                onDismissRequest = { showConfigWarning = false },
                title = {
                    Text("‚ö†Ô∏è Êú™ÈÖçÁΩÆ LLM Ê®°Âûã")
                },
                text = {
                    Column {
                        Text("ËØ∑ÂÖàÈÖçÁΩÆ LLM Ê®°ÂûãÊâçËÉΩ‰ΩøÁî® AI ÂäüËÉΩ„ÄÇ")
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            "ÁÇπÂáªÂè≥‰∏ãËßíÁöÑÊ®°ÂûãÈÄâÊã©Âô®ËøõË°åÈÖçÁΩÆ„ÄÇ",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                },
                confirmButton = {
                    TextButton(onClick = { showConfigWarning = false }) {
                        Text("Áü•ÈÅì‰∫Ü")
                    }
                }
            )
        }
        
        // ÈîôËØØÊèêÁ§∫ÂºπÁ™ó
        if (showErrorDialog) {
            AlertDialog(
                onDismissRequest = { showErrorDialog = false },
                title = {
                    Text("‚ùå LLM API ÈîôËØØ")
                },
                text = {
                    Column(modifier = Modifier.verticalScroll(rememberScrollState())) {
                        Text(
                            "Ë∞ÉÁî® LLM API Êó∂ÂèëÁîüÈîôËØØÔºö",
                            style = MaterialTheme.typography.bodyMedium,
                            fontWeight = androidx.compose.ui.text.font.FontWeight.Bold
                        )
                        Spacer(modifier = Modifier.height(12.dp))
                        
                        // ÈîôËØØ‰ø°ÊÅØÂç°Áâá
                        Card(
                            modifier = Modifier.fillMaxWidth(),
                            colors = CardDefaults.cardColors(
                                containerColor = MaterialTheme.colorScheme.errorContainer
                            )
                        ) {
                            SelectionContainer {
                                Text(
                                    text = errorMessage,
                                    style = MaterialTheme.typography.bodySmall.copy(
                                        fontFamily = androidx.compose.ui.text.font.FontFamily.Monospace
                                    ),
                                    color = MaterialTheme.colorScheme.onErrorContainer,
                                    modifier = Modifier.padding(12.dp)
                                )
                            }
                        }
                        
                        Spacer(modifier = Modifier.height(12.dp))
                        
                        // Â∏∏ËßÅÈóÆÈ¢òÊèêÁ§∫
                        Text(
                            "Â∏∏ËßÅËß£ÂÜ≥ÊñπÊ≥ïÔºö",
                            style = MaterialTheme.typography.bodySmall,
                            fontWeight = androidx.compose.ui.text.font.FontWeight.Bold
                        )
                        Spacer(modifier = Modifier.height(4.dp))
                        Text(
                            "‚Ä¢ Ê£ÄÊü• API Key ÊòØÂê¶Ê≠£Á°Æ\n" +
                            "‚Ä¢ Á°ÆËÆ§Ë¥¶Êà∑‰ΩôÈ¢ùÂÖÖË∂≥\n" +
                            "‚Ä¢ Ê£ÄÊü•ÁΩëÁªúËøûÊé•\n" +
                            "‚Ä¢ È™åËØÅÊ®°ÂûãÂêçÁß∞ÊòØÂê¶Ê≠£Á°Æ",
                            style = MaterialTheme.typography.bodySmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                },
                confirmButton = {
                    TextButton(onClick = { showErrorDialog = false }) {
                        Text("ÂÖ≥Èó≠")
                    }
                },
                dismissButton = {
                    TextButton(
                        onClick = {
                            showErrorDialog = false
                            // ÊâìÂºÄÊ®°ÂûãÈÖçÁΩÆ
                        }
                    ) {
                        Text("ÈáçÊñ∞ÈÖçÁΩÆ")
                    }
                }
            )
        }
}

