<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoDev Xiuper - AI Coding Assistant</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: #0f0f1a;
        }
        #ComposeTarget {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Xiuper Loading Animation - Rocket through X */
        #xuiper-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        #xuiper-loader.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loader-container {
            position: relative;
            width: 200px;
            height: 200px;
        }

        /* X mark - glows when rocket passes */
        .x-mark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
        }
        .x-mark::before,
        .x-mark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #ec4899);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
            animation: x-glow 2.5s ease-in-out infinite;
        }
        .x-mark::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .x-mark::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        @keyframes x-glow {
            0%, 30% {
                box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
                filter: brightness(0.7);
            }
            40%, 60% {
                box-shadow: 0 0 30px rgba(236, 72, 153, 0.8), 0 0 60px rgba(99, 102, 241, 0.6);
                filter: brightness(1.3);
            }
            70%, 100% {
                box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
                filter: brightness(0.7);
            }
        }

        /* Rocket */
        .rocket {
            position: absolute;
            top: 50%;
            left: -30px;
            transform: translateY(-50%);
            width: 24px;
            height: 8px;
            animation: rocket-fly 2.5s ease-in-out infinite;
        }
        .rocket-body {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #ec4899, #6366f1, #fff);
            border-radius: 4px 8px 8px 4px;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.8);
        }
        .rocket-head {
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid #fff;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }

        /* Fire trail */
        .fire-trail {
            position: absolute;
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            width: 60px;
            height: 6px;
            background: linear-gradient(90deg, transparent, rgba(236, 72, 153, 0.3), rgba(236, 72, 153, 0.7));
            border-radius: 3px;
            animation: fire-flicker 0.1s ease-in-out infinite alternate;
        }
        .fire-trail::before {
            content: '';
            position: absolute;
            top: -2px;
            right: 0;
            width: 40px;
            height: 10px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.5));
            border-radius: 5px;
        }

        @keyframes rocket-fly {
            0% { left: -40px; }
            100% { left: 220px; }
        }

        @keyframes fire-flicker {
            0% { opacity: 0.8; width: 55px; }
            100% { opacity: 1; width: 65px; }
        }

        /* Energy burst when rocket passes X */
        .energy-burst {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(236, 72, 153, 0.8);
            animation: burst 2.5s ease-out infinite;
            opacity: 0;
        }
        .energy-burst:nth-child(2) { animation-delay: 0.1s; }
        .energy-burst:nth-child(3) { animation-delay: 0.2s; }

        @keyframes burst {
            0%, 35% {
                width: 20px;
                height: 20px;
                opacity: 0;
            }
            40% {
                width: 20px;
                height: 20px;
                opacity: 0.9;
            }
            70% {
                width: 150px;
                height: 150px;
                opacity: 0;
            }
            100% {
                width: 150px;
                height: 150px;
                opacity: 0;
            }
        }

        /* Sparks */
        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #fff;
            opacity: 0;
            animation: spark 2.5s ease-out infinite;
        }
        .spark:nth-child(1) { top: 50%; left: 50%; animation-delay: 0.4s; }
        .spark:nth-child(2) { top: 30%; left: 60%; animation-delay: 0.45s; }
        .spark:nth-child(3) { top: 70%; left: 60%; animation-delay: 0.42s; }
        .spark:nth-child(4) { top: 40%; left: 40%; animation-delay: 0.48s; }
        .spark:nth-child(5) { top: 60%; left: 40%; animation-delay: 0.44s; }
        .spark:nth-child(6) { top: 35%; left: 50%; animation-delay: 0.46s; }
        .spark:nth-child(7) { top: 65%; left: 50%; animation-delay: 0.43s; }
        .spark:nth-child(8) { top: 50%; left: 35%; animation-delay: 0.47s; }

        @keyframes spark {
            0%, 38% {
                opacity: 0;
                transform: translate(0, 0) scale(1);
            }
            40% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            70% {
                opacity: 0;
                transform: translate(calc((var(--dx, 0) * 40px)), calc((var(--dy, 0) * 40px))) scale(0.5);
            }
            100% { opacity: 0; }
        }
        .spark:nth-child(1) { --dx: 1; --dy: 0; }
        .spark:nth-child(2) { --dx: 0.7; --dy: -0.7; }
        .spark:nth-child(3) { --dx: 0.7; --dy: 0.7; }
        .spark:nth-child(4) { --dx: -0.7; --dy: -0.5; }
        .spark:nth-child(5) { --dx: -0.7; --dy: 0.5; }
        .spark:nth-child(6) { --dx: 0; --dy: -1; }
        .spark:nth-child(7) { --dx: 0; --dy: 1; }
        .spark:nth-child(8) { --dx: -1; --dy: 0; }

        /* Text */
        .loader-text {
            margin-top: 40px;
            text-align: center;
        }
        .loader-title {
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        .loader-slogan {
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 1rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 2px;
            margin-bottom: 15px;
        }
        .loader-subtitle {
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 2px;
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
            100% { content: ''; }
        }

        /* Progress bar */
        .progress-container {
            margin-top: 30px;
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #6366f1, #ec4899);
            border-radius: 2px;
            transition: width 0.3s ease-out;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        .progress-text {
            margin-top: 10px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <!-- Xiuper Loading Animation -->
    <div id="xuiper-loader">
        <div class="loader-container">
            <!-- Energy burst rings -->
            <div class="energy-burst"></div>
            <div class="energy-burst"></div>
            <div class="energy-burst"></div>

            <!-- Sparks -->
            <div class="spark"></div>
            <div class="spark"></div>
            <div class="spark"></div>
            <div class="spark"></div>
            <div class="spark"></div>
            <div class="spark"></div>
            <div class="spark"></div>
            <div class="spark"></div>

            <!-- X mark -->
            <div class="x-mark"></div>

            <!-- Rocket -->
            <div class="rocket">
                <div class="fire-trail"></div>
                <div class="rocket-body"></div>
                <div class="rocket-head"></div>
            </div>
        </div>

        <div class="loader-text">
            <div class="loader-title">Xiuper</div>
            <div class="loader-slogan">One Platform. All Phases. Every Device.</div>
            <div class="loader-subtitle">Loading WASM<span class="loading-dots"></span></div>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">Initializing...</div>
    </div>

    <canvas id="ComposeTarget"></canvas>

    <script>
        // Track WASM loading progress
        var progressBar = document.getElementById('progress-bar');
        var progressText = document.getElementById('progress-text');
        var loader = document.getElementById('xuiper-loader');

        var READY_EVENT = 'xiuper:wasm-ready';
        var ready = false;

        function connectionHint() {
            var c = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (!c) return '';
            var parts = [];
            if (c.effectiveType) parts.push(c.effectiveType);
            if (typeof c.downlink === 'number') parts.push(c.downlink + 'Mb/s');
            return parts.length ? (' (' + parts.join(', ') + ')') : '';
        }

        function markReadyAndHide() {
            if (ready) return;
            ready = true;
            // Give the app a tiny moment to paint before hiding the overlay.
            progressText.textContent = 'Starting application...';
            setTimeout(hideLoader, 150);
        }

        window.addEventListener(READY_EVENT, function() {
            markReadyAndHide();
        });

        // If WASM signaled readiness before this script ran (rare), still handle it.
        if (window.__XIUPER_WASM_READY__) {
            markReadyAndHide();
        }

        // Slow network hints (WASM + fonts can be large)
        setTimeout(function() {
            if (!ready) {
                progressText.textContent = '网络似乎较慢' + connectionHint() + '，WASM/字体资源可能需要更久，请耐心等待…';
            }
        }, 6000);
        setTimeout(function() {
            if (!ready) {
                progressText.textContent = '仍在加载中：建议检查网络/代理，或稍后刷新页面。';
            }
        }, 15000);

        window.addEventListener('error', function() {
            if (!ready) {
                progressText.textContent = '加载失败：请刷新页面或检查网络/控制台错误信息。';
            }
        });
        window.addEventListener('unhandledrejection', function() {
            if (!ready) {
                progressText.textContent = '加载失败：请刷新页面或检查网络/控制台错误信息。';
            }
        });

        // Simulate progress stages for WASM loading
        var stages = [
            { progress: 10, text: 'Fetching WASM module...' },
            { progress: 30, text: 'Compiling WASM...' },
            { progress: 50, text: 'Initializing runtime...' },
            { progress: 70, text: 'Loading resources...' },
            { progress: 90, text: 'Starting application...' }
        ];

        var currentStage = 0;
        var stageInterval = setInterval(function() {
            if (currentStage < stages.length) {
                progressBar.style.width = stages[currentStage].progress + '%';
                progressText.textContent = stages[currentStage].text;
                currentStage++;
            }
        }, 800);

        // Hide loader when Compose canvas is ready
        function hideLoader() {
            clearInterval(stageInterval);
            progressBar.style.width = '100%';
            progressText.textContent = 'Ready!';

            setTimeout(function() {
                loader.classList.add('fade-out');
                setTimeout(function() {
                    loader.style.display = 'none';
                }, 500);
            }, 300);
        }

        // Watch for canvas to become active (Compose renders to it)
        var canvas = document.getElementById('ComposeTarget');
        var observer = new MutationObserver(function(mutations) {
            // Check if canvas has content (width/height attributes set by Compose)
            if (canvas.width > 0 && canvas.height > 0) {
                observer.disconnect();
                markReadyAndHide();
            }
        });

        observer.observe(canvas, {
            attributes: true,
            attributeFilter: ['width', 'height']
        });

        // Fallback: after a long wait, keep overlay but show a stronger hint (do NOT hide blindly)
        setTimeout(function() {
            if (!ready) {
                progressBar.style.width = '95%';
                progressText.textContent = '加载时间较长：可能是网络较慢或被拦截，建议切换网络/代理或刷新重试。';
            }
        }, 30000);

        // Also hide when window fully loads (backup)
        window.addEventListener('load', function() {
            setTimeout(function() {
                // If the app already painted to canvas, treat it as ready (heuristic fallback)
                if (!ready && canvas && canvas.width > 0 && canvas.height > 0) {
                    markReadyAndHide();
                }
            }, 1000);
        });
    </script>

    <script type="module" src="mpp-ui.js"></script>
</body>
</html>

